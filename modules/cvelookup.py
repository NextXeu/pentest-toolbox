"""
Project name: Pentest ToolBox
Version: 1.0
Copyright© x/x/2022, DEMARD Jérémy et Xavier 

"""

from requests_html import HTMLSession
from bs4 import BeautifulSoup
import requests


def CVELookUp(id):

    #Rechercher des infos sur une CVE
    URL = "https://cvedetails.com"

    cveQuery = requests.get(URL+"/cve/"+id)
    status = True

    if cveQuery.status_code != 200:
        print("Vérifiez l'état du site https://cvedetails.com")
        status = False
    
    if "Unknown CVE ID" in cveQuery.text:
        print("Cette CVE n'est pas référencée ou n'existe pas")
        status = False

    if status:   
        html = cveQuery.content
        soup = BeautifulSoup(html,"html.parser")

        cveScoreTable = soup.find(id='cvssscorestable').text.strip()
        elements = cveScoreTable.split("\n")

        data = list(filter(None, elements)) #Remove empty fields
        
        tabIndex = {
            'score': data.index('CVSS Score')+1,
            'confidentiality': data.index('Confidentiality Impact')+1,
            'integrity': data.index('Confidentiality Impact')+1,
            'availability' : data.index('Availability Impact')+1,
            'complexity' : data.index('Access Complexity')+1,
            'authentication' : data.index('Authentication')+1,
            'access' : data.index('Gained Access')+1,
            'cwe' : data.index('CWE ID')+1
        }

        displayInfos = f"\n\n===================================\n"
        displayInfos+= f"Informations sur la "+id
        displayInfos+= f"\n===================================\n"
        check = True

        #Check if index exists in data:
        if (check):
            for key in tabIndex:
                if data[tabIndex[key]] != "" and int(tabIndex[key]) and tabIndex[key] != "":
                    displayInfos+= f"\n[+] {key}:  {data[tabIndex[key]]}"
                else:
                    check = False
        
        return displayInfos
